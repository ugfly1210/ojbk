{% extends 'home_site.html' %}

{% block content %}
{#        <link rel="stylesheet" href="/static/blog/bootstrap-3.3.7-dist/css/bootstrap.css">#}

    <style>
    .comment{
        margin-left: 30px;
    }
    </style>
    {% csrf_token %}
    <div class="jumbotron">
        <h2 style="text-align: center;color: #1b6d85">{{ obj.title }}</h2>
        <br>
        <h5>{{ obj.articledetail.content }}</h5>
    </div>

    <div class="art_poll_up">
        <button id="art_up" class="fa fa-thumbs-up fa-2x btn btn-danger pull-right">Great! <span
                id="art_up_count">{{ obj.poll_count }}</span></button>
        {#            <span class="art_up_error"></span>#}
    </div>
    <div style="padding-top: 50px"><span class="label label-warning  art_up_error pull-right"></span></div>
    {#   è¸©#}
    {#<div><button class="fa fa-thumbs-down fa-2x btn btn-primary pull-right">Great! <span id="digg_count">{{ obj.poll_count }}</span></button></div>#}
    <div class="panel panel-primary has_art_comment" style="margin-top: 20px;opacity:0.8">
    <div class="panel-heading" style="background-color: palevioletred;"><h5 class="panel-title">å·²å‘è¡¨è¯„è®ºğŸŒ²(æ ‘) : </h5></div>
    <div class="panel-body comment_tree_list">
{#<div class="comment" >#}
{#    <div class="content"><span>'+val+'</span>#}
{#    </div>#}
    </div>

        <div class="panel-heading" style="background-color:#a94442;"><h5 class="panel-title">å·²å‘è¡¨è¯„è®º&nbsp;&nbsp;&nbsp;:</h5></div>
        {#        æ‹¿åˆ°å½“å‰æ–‡ç« çš„æ‰€æœ‰è¯„è®º,è¦åœ¨æ–‡ç« ç›¸å…³çš„urlsé‡Œé¢å–åˆ°æ‰€æœ‰çš„è¯„è®º,æ–‡ç« ç›¸å…³èµ°çš„æ˜¯article_detailè§†å›¾#}
        <div class="panel-body comment_list">
            {% for comment in comment_list %}
                        <div class="hides" comment_user_avr="{{ comment.user.avatar.url }}" comment_nickname=""></div>
                <div class="comment_item">
                    <div class="row">{# è¿™é‡Œæ”¾çš„æ˜¯è¯„è®ºå¤´ #}
                        <div class="col-lg-7"><img src="{{ comment.user.avatar.url }}" alt="" height="30" width="30">
                            <a href="/blog/{{ comment.user.nickname }}/">{{ comment.user.nickname }}</a>
                            &nbsp;&nbsp;&nbsp;å‘è¡¨äº&nbsp;&nbsp;&nbsp;{{ comment.create_time|date:'Y-m-d H:i:s' }}</div>
                        <div class="pull-right"><a href="#content_area" class="reply_comment_btn"
                                                   comment_nickname="{{ comment.user.nickname }}"
                                                   Pid="{{ comment.id }}">å›å¤</a>
                            <a href="">é¡¶å®ƒ</a></div>
                    </div>
                        {% if comment.parent_comment_id %}
                            <div>@<a href="/blog/{{ comment.parent_comment.user.nickname }}/">{{ comment.parent_comment.user.nickname }}</a><span>{{ comment.parent_comment.content }}</span></div>
                        {% endif %}
                        <div>{{ comment.content }}</div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="panel panel-default" style="opacity:0.8">
        <div class="panel-heading">
            <p class="panel-title">æˆ‘æ˜¯&nbsp;&nbsp;<input type="text" disabled="disabled" size="20"
                                                        value="{{ request.session.nickname }}">&nbsp;,&nbsp;æˆ‘æƒ³å¯¹å®ƒè¯´&nbsp;&nbsp;:
            </p></div>
        <div class="panel-body">
            {#  <div class="well well-lg >#}
            <p>è¯„è®ºå†…å®¹: </p>
            <form>
                <p><textarea name="" id="content_area" cols="60" rows="10">è¯´çˆ±æˆ‘...</textarea></p>
                <input type="button" value="æäº¤è¯„è®º" class="btn btn-danger commentBtn">
            </form>
        </div>
    </div>
    <script src="/static/blog/jquery-3.2.1.js"></script>
    <script>
    console.log('{{ request.session.nickname }}');
        //ç‚¹èµåŠŸèƒ½å®ç°
        $('#art_up').click(function () {
            alert(location.pathname)
            $.ajax({
                url: '/blog/poll/',
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    {#                è¦çŸ¥é“ç‚¹èµçš„æ˜¯å“ªç¯‡æ–‡ç« #}
                    article_id: '{{ obj.id }}'
                },
                success: function (data) {
                    var data = JSON.parse(data);
                    console.log(data);
                    if (data.state) {
                        var val = parseInt($('#art_up_count').html()) + 1;
                        $('#art_up_count').html(val)
                    }
                    else if (data.repeat) {
                        $('.art_up_error').html('è¯·å‹¿é‡å¤ç‚¹èµ').show(300).delay(2000).hide(500)
                    }
                }
            })
        });

        //å®ç°æ–‡ç« è¯„è®ºåŠŸèƒ½. ç‚¹å‡»æŒ‰é’®,æ‹¿åˆ°textareaé‡Œé¢çš„å€¼.ä¼ åˆ°åå°,å­˜è¿›æ•°æ®åº“
        //æˆ‘ä»¬åœ¨dataé‡Œé¢è¦ä¼ çš„å€¼: è¦çŸ¥é“ æ˜¯å“ªä¸ªäººå¯¹å“ªç¯‡æ–‡ç« å‘è¡¨äº†ä»€ä¹ˆè¯„è®º.
        // è¿™ä¸ªäººå°±æ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ·,æˆ‘ä»¬å¯ä»¥åœ¨sessioné‡Œé¢æ‹¿.  åå°ä¼ è¿‡æ¥çš„objå°±æ˜¯æ–‡ç« çš„å¯¹è±¡
        // json ä¸èƒ½å­˜å¯¹è±¡

        //ajaxæ–‡ç« è¯„è®º
        $('.commentBtn').click(function () {
            //åˆ¤æ–­è¯„è®ºåŒºçš„å¼€å¤´æ˜¯å¦ä»¥@å¼€å¤´(è¿™ç§æƒ…å†µä¸»è¦æ˜¯é’ˆå¯¹,ç‚¹äº†å›å¤å,åœ¨è¯„è®ºæ¡†æ‰‹åŠ¨åˆ é™¤,ä½†æ˜¯æ•°æ®åº“å·²ç»åˆ›å»ºçˆ¶idäº†
            var content = $('#content_area').val();
            //åˆ¤æ–­Pidæ˜¯å¦æœ‰å€¼, å¦‚æœæœ‰å°±æ˜¯å­è¯„è®º,ä¼ å€¼çš„æ—¶å€™è¦åˆ‡æ‰æœ€å‰é¢çš„ç”¨æˆ·å
            if (Pid){
                var index=content.indexOf('\n');
                    content = content.slice(index+1)
            }
            $.ajax({
                url: '/blog/comment/',
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    Pid: Pid,
                    article_id: {{ obj.id }},
                    content: content
                },
                success: function (data) {

                    console.log(data.create_time.slice(19));
                    //åœ¨é¡µé¢åˆ›å»ºè¯„è®ºå“¦,           append() æ–¹æ³•åœ¨è¢«é€‰å…ƒç´ çš„ç»“å°¾ï¼ˆä»ç„¶åœ¨å†…éƒ¨ï¼‰æ’å…¥æŒ‡å®šå†…å®¹
                    if (!Pid){
                        s = '<div class="comment_item"><div class="row">{# è¿™é‡Œæ”¾çš„æ˜¯è¯„è®ºå¤´ #}<div class="col-lg-7"><img src="'+data.ava+'" alt="" height="30" width="30"><a href="/blog/{{ request.session.nickname }}/">{{ request.session.nickname }}</a>&nbsp;&nbsp;&nbsp;å‘è¡¨äº&nbsp;&nbsp;&nbsp;' + data.create_time.slice(0, 19) + '</div><div class="pull-right"><a href="#content_area" class="reply_comment_btn" comment_nickname="{{ request.session.nickname }}" Pid=' + data.comment_id + '>å›å¤</a><a href="">é¡¶å®ƒ</a></div></div><div>' + content + '</div></div>';
                    } else{
                        s = '<div class="comment_item"><div class="row">{# è¿™é‡Œæ”¾çš„æ˜¯è¯„è®ºå¤´ #}<div class="col-lg-7"><img src="'+data.ava+'" alt="" height="30" width="30"><a href="/blog/{{ request.session.nickname }}/">{{ request.session.nickname }}</a>&nbsp;&nbsp;&nbsp;å‘è¡¨äº&nbsp;&nbsp;&nbsp;' + data.create_time.slice(0, 19) + '</div><div class="pull-right"><a href="#content_area" class="reply_comment_btn" comment_nickname="{{ request.seesion.nickname }}" Pid=' + data.comment_id + '>å›å¤</a><a href="">é¡¶å®ƒ</a></div></div>'+'<div>@<a href="/blog/'+data.parent_comment_nickname+'/">:&nbsp;&nbsp;&nbsp;'+data.parent_comment_nickname+'</a>:&nbsp;&nbsp;&nbsp;<span>'+data.parent_comment_content+'</span></div><div>' + content + '</div></div>';
}

                    $('.comment_list').append(s);
                    //æ¸…ç©ºè¯„è®ºæ¡†çš„å†…å®¹
                    $('#content_area').val('...')
                }
            })
        });

        //Pidåº”è¯¥æœ‰ä¸€ä¸ªé»˜è®¤çš„å€¼, ç”¨æˆ·å¦‚æœç‚¹äº†å›å¤,å°±å‘é€è¯¥å€¼,å¦‚æœæ²¡ç‚¹ å°±é»˜è®¤ä¸ºç©º
        var Pid = null;
        //Ajaxå®ç°å­è¯„è®º   ç”¨äº‹ä»¶å§”æ´¾:å› ä¸ºè¦æ–°åˆ›å»ºæ ‡ç­¾,ä½†æ˜¯äº‹ä»¶ä¹‹å‰å·²ç»ç»‘å®š, æ‰€ä»¥ç”¨äº‹ä»¶å§”æ´¾
        $('.comment_list').on('click', '.reply_comment_btn', function () {
            //æ–‡æœ¬æ¡†ä¸­æ˜¾ç¤ºçˆ¶çº§è¯„è®ºçš„æ˜µç§° å‰é¢åŠ @ç¬¦å·
            //ç‚¹å‡»å›å¤ä¹‹å,åº”è¯¥æ˜¯å…ˆè·³è½¬åˆ°è¯„è®ºæ¡†,ä¸€ç§æ–¹æ³•æ˜¯ : åœ¨aæ ‡ç­¾é‡Œé¢,hrefç›´æ¥å†™è¦è·³è½¬åˆ°çš„æ ‡ç­¾
            //ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯, focus    å‰é¢æ˜¯ç„¦ç‚¹
            $('#content_area').focus();
            // å›å¤è¯„è®º,  æ ¼å¼ : å•ç‹¬ä¸€è¡Œæ˜¯@ç”¨æˆ·å, è¿™ä¸ªç”¨æˆ·åæ˜¯å½“å‰è¯„è®ºçš„ç”¨æˆ·çš„ç”¨æˆ·å

            //attrå¯ä»¥è¿”å›å±æ€§å€¼(ä¸€ä¸ªå‚æ•°), ä¹Ÿå¯ä»¥è®¾ç½®å±æ€§(ä¿©å‚æ•°).
            var parent_comment_nickname = $(this).attr('comment_nickname');
            $('#content_area').val('@' + parent_comment_nickname + '\n');

            //è¦æ‹¿åˆ°ä¸€ä¸ªPid,  ä¼ è¿‡å»è®©åå°åˆ¤æ–­æ˜¯å¦ä¸ºå­è¯„è®º
            Pid = $(this).attr('Pid')
        })

        //è¯„è®ºæ ‘ğŸŒ²
        $.ajax({
            url : '/blog/comment_tree/{{ obj.id }}/',
            success:function (data) {
                console.log(JSON.parse(data));
                var data = JSON.parse(data);
                var s = ShowCommentTree(data);
                $('.comment_tree_list').append(s)

            }
        });

        //å±•å¼€è¯„è®ºğŸŒ²
        function ShowCommentTree(comment_list) {
            var html = '';
            $.each(comment_list,function (i,comment_dict) {
                var val = comment_dict['content'];
                //ç»™æ ‘åˆ›é€ æ ‡ç­¾
                var comment_str= '<div class="comment" ><div class="content"><span>'+val+'</span></div>';

                if (comment_dict['children_comment_list']){
                    var s = ShowCommentTree(comment_dict['children_comment_list']);
                    comment_str += s
                }
                comment_str += '</div>';
                html += comment_str
            });
            return html
        }
    </script>



{% endblock %}